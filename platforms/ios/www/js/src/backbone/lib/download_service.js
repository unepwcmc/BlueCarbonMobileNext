// Generated by CoffeeScript 1.7.1
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.DownloadService = (function() {
    var MAX_ZOOM_LEVEL;

    MAX_ZOOM_LEVEL = 17;

    function DownloadService(area, offlineLayer) {
      this.area = area;
      this.offlineLayer = offlineLayer;
      this.notifyCompletedJob = __bind(this.notifyCompletedJob, this);
      this.deleteFile = __bind(this.deleteFile, this);
      this.downloadHabitatTiles = __bind(this.downloadHabitatTiles, this);
      this.downloadHabitats = __bind(this.downloadHabitats, this);
      this.downloadBaseLayer = __bind(this.downloadBaseLayer, this);
      this.completedPercentage = 0;
      this.totalJobs = 0;
      this.completedJobs = 0;
    }

    DownloadService.prototype.downloadArea = function() {
      this.calculateTotalJobs();
      return this.removeExistingTiles().then(this.downloadHabitats).then(this.downloadBaseLayer);
    };

    DownloadService.prototype.downloadBaseLayer = function() {
      return new Promise((function(_this) {
        return function(resolve, reject) {
          _this.offlineLayer.on('tilecachingprogress', _this.notifyCompletedJob);
          return _this.offlineLayer.saveTiles(MAX_ZOOM_LEVEL, (function() {}), resolve, reject, _this.areaBounds());
        };
      })(this));
    };

    DownloadService.prototype.downloadHabitats = function() {
      return new Promise((function(_this) {
        return function(resolve, reject) {
          var layers;
          layers = _this.area.get('mbtiles');
          return async.map(layers, _this.downloadHabitatTiles, function(err, results) {
            if (err != null) {
              return reject(err);
            }
            return resolve(results);
          });
        };
      })(this));
    };

    DownloadService.prototype.downloadHabitatTiles = function(layer, callback) {
      var ft, success;
      this.updateArea(layer);
      success = (function(_this) {
        return function(fileEntry) {
          _this.area.localSave();
          _this.notifyCompletedJob();
          return callback(null, fileEntry);
        };
      })(this);
      ft = new FileTransfer();
      return ft.download(layer.url, this.area.filenameForLayer(layer), success, callback);
    };

    DownloadService.prototype.updateArea = function(layer) {
      var index, mbTiles, storedLayer, _i, _len;
      layer.downloadedAt = (new Date()).getTime();
      mbTiles = this.area.get('mbtiles');
      for (index = _i = 0, _len = mbTiles.length; _i < _len; index = ++_i) {
        storedLayer = mbTiles[index];
        if (storedLayer.habitat === layer.habitat) {
          mbTiles[index] = layer;
        }
      }
      return this.area.set('mbtiles', mbTiles);
    };

    DownloadService.prototype.removeExistingTiles = function() {
      return new Promise((function(_this) {
        return function(resolve, reject) {
          var layers;
          layers = _this.area.get('mbtiles');
          return async.each(layers, _this.deleteFile, function(err, results) {
            if (err != null) {
              return reject(err);
            }
            return resolve(results);
          });
        };
      })(this));
    };

    DownloadService.prototype.deleteFile = function(layer, callback) {
      var filename;
      filename = this.area.filenameForLayer(layer, false);
      return window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, (function(fs) {
        return fs.root.getFile(filename, {}, (function(fileEntry) {
          return fileEntry.remove((function() {
            return callback();
          }), callback);
        }), (function() {
          return callback();
        }));
      }), callback);
    };

    DownloadService.prototype.calculateTotalJobs = function() {
      var layers;
      layers = this.area.get('mbtiles');
      return this.totalJobs = this.offlineLayer.calculateNbTiles(MAX_ZOOM_LEVEL, this.areaBounds()) + layers.length;
    };

    DownloadService.prototype.notifyCompletedJob = function() {
      this.completedJobs += 1;
      this.completedPercentage = (this.completedJobs * 100) / this.totalJobs;
      return typeof this.onPercentageChange === "function" ? this.onPercentageChange(this.completedPercentage) : void 0;
    };

    DownloadService.prototype.areaBounds = function() {
      var areaBounds, areaZoom;
      areaBounds = this.area.bounds();
      areaZoom = this.offlineLayer._map.getBoundsZoom(areaBounds);
      return {
        min: this.offlineLayer._map.project(areaBounds.getNorthWest(), areaZoom),
        max: this.offlineLayer._map.project(areaBounds.getSouthEast(), areaZoom)
      };
    };

    return DownloadService;

  })();

}).call(this);
