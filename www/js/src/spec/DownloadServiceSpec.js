// Generated by CoffeeScript 1.7.1
(function() {
  describe("DownloadService", function() {
    it("should be a thing that exists", function() {
      return expect(DownloadService).toBeDefined();
    });
    it("given an area, stores the area as an instance variable", function() {
      var area, offlineLayer, service;
      area = {};
      offlineLayer = {};
      service = new DownloadService(area, offlineLayer);
      return expect(service.area).toBe(area);
    });
    beforeEach(function() {
      return window.cordova = {
        file: {
          documentsDirectory: "/User/Lieferschein/Documents/"
        }
      };
    });
    describe(".downloadHabitatTiles()", function() {
      beforeEach(function() {
        this.area = new BlueCarbon.Models.Area({
          id: 12
        });
        this.service = new DownloadService(this.area, {});
        sinon.stub(this.service, 'updateArea');
        this.layer = {
          habitat: "seagrass",
          url: "http://seagrass.com/api/seagrass.json"
        };
        return window.FileTransfer = function() {};
      });
      it("given a habitat layer object, downloads the mbtiles file for the habitat and saves to the file system", function(done) {
        var mbtilesPath, spy;
        FileTransfer.prototype = {
          download: function(url, name, callback) {
            return callback();
          }
        };
        spy = sinon.spy(FileTransfer.prototype, "download");
        mbtilesPath = "/User/Lieferschein/Documents/12-seagrass.mbtiles";
        return this.service.downloadHabitatTiles(this.layer, (function(_this) {
          return function() {
            expect(spy.calledWith(_this.layer.url, mbtilesPath)).toBe(true);
            return done();
          };
        })(this));
      });
      return it("passes an error with the callback if the transfer is unsuccessful", function(done) {
        FileTransfer.prototype = {
          download: function(url, name, cb, errorcb) {
            return errorcb("ERRORORORORRORORO");
          }
        };
        return this.service.downloadHabitatTiles(this.layer, function(error) {
          expect(error).toBe("ERRORORORORRORORO");
          return done();
        });
      });
    });
    describe('.updateArea', function() {
      return it("sets the mbtiles attribute on the Area", function() {
        var area, expectedLayers, layers, newLayer, saveStub, service;
        layers = [
          {
            habitat: 'mangroves'
          }, {
            habitat: 'seamarshsaltoves'
          }
        ];
        newLayer = {
          habitat: 'mangroves',
          tatibah: 'sevorgnam'
        };
        area = new BlueCarbon.Models.Area({
          id: 12,
          mbtiles: layers
        });
        saveStub = sinon.stub(area, 'localSave');
        sinon.stub(Date.prototype, 'getTime', function() {
          return 1234567;
        });
        service = new DownloadService(area, {});
        service.updateArea(newLayer);
        expectedLayers = [
          {
            habitat: 'mangroves',
            tatibah: 'sevorgnam',
            downloadedAt: 1234567
          }, {
            habitat: 'seamarshsaltoves'
          }
        ];
        expect(area.get('mbtiles')).toEqual(expectedLayers);
        return expect(saveStub.called).toBe(true);
      });
    });
    describe(".downloadHabitats", function() {
      beforeEach(function() {
        this.layers = [
          {
            habitat: "seagrass",
            url: "http://seagrass.com/api/seagrass.json"
          }, {
            habitat: "mangroves",
            url: "https://mangroves.io/api/mangroves.json"
          }
        ];
        this.area = new BlueCarbon.Models.Area({
          id: 12,
          mbtiles: this.layers
        });
        this.service = new DownloadService(this.area, {});
        sinon.stub(this.service, 'updateArea');
        window.FileTransfer = function() {};
        return FileTransfer.prototype = {
          download: function(url, name, callback) {
            return callback();
          }
        };
      });
      return it("downloads the habitat layers", function(done, fail) {
        return this.service.downloadHabitats().then(done)["catch"](fail);
      });
    });
    describe('.downloadBaseLayer', function() {
      beforeEach(function() {
        this.offlineLayer = {
          saveTiles: (function() {}),
          on: (function() {})
        };
        this.area = new BlueCarbon.Models.Area({
          id: 12
        });
        return this.service = new DownloadService(this.area, this.offlineLayer);
      });
      it('resolves the promise if the tile saving is successful', function(done, fail) {
        var stub;
        stub = sinon.stub(this.offlineLayer, 'saveTiles', function(zoom, startcb, cb, errorcb) {
          return cb();
        });
        return this.service.downloadBaseLayer().then(function() {
          expect(stub.called).toBe(true);
          return done();
        })["catch"](function(err) {
          return console.log(err);
        });
      });
      return it('rejects the promise if the tile saving is unsuccessful', function(done, fail) {
        var stub;
        stub = sinon.stub(this.offlineLayer, 'saveTiles', function(zoom, startcb, cb, errorcb) {
          return errorcb(new Error('ERRORORORO'));
        });
        return this.service.downloadBaseLayer().then(fail)["catch"](function() {
          expect(stub.called).toBe(true);
          return done();
        });
      });
    });
    describe('.downloadArea', function() {
      beforeEach(function() {
        this.offlineLayer = {
          saveTiles: (function() {}),
          calculateNbTiles: (function() {
            return [];
          }),
          on: (function() {})
        };
        this.area = new BlueCarbon.Models.Area({
          id: 12,
          mbtiles: []
        });
        return this.service = new DownloadService(this.area, this.offlineLayer);
      });
      return it('calculates number of total jobs, downloads habitats and base layer', function(done, fail) {
        var calculateTotalJobsStub, downloadBaseLayerStub, downloadHabitatsStub;
        calculateTotalJobsStub = sinon.stub(this.service, 'calculateTotalJobs');
        downloadHabitatsStub = sinon.stub(this.service, 'downloadHabitats').returns(Promise.resolve());
        downloadBaseLayerStub = sinon.stub(this.service, 'downloadBaseLayer').returns(Promise.resolve());
        return this.service.downloadArea({}).then(function() {
          expect(calculateTotalJobsStub.called).toBe(true);
          expect(downloadHabitatsStub.called).toBe(true);
          expect(downloadBaseLayerStub.called).toBe(true);
          return done();
        })["catch"](fail);
      });
    });
    describe('.calculateTotalJobs', function() {
      return it('calculates how many tiles and habitats have to be downloaded', function() {
        var area, offlineLayer, service;
        offlineLayer = {
          calculateNbTiles: (function() {
            return 100;
          })
        };
        area = new BlueCarbon.Models.Area({
          id: 12,
          mbtiles: ['habitat1', 'habitat2']
        });
        service = new DownloadService(area, offlineLayer);
        return expect(service.calculateTotalJobs()).toBe(102);
      });
    });
    return describe('.notifyCompletedJob', function() {
      it('augments the number of completed jobs and the completion percentage', function() {
        var service;
        service = new DownloadService({}, {});
        service.totalJobs = 2;
        expect(service.completedJobs).toBe(0);
        expect(service.completedPercentage).toBe(0);
        service.notifyCompletedJob();
        expect(service.completedJobs).toBe(1);
        return expect(service.completedPercentage).toBe(50);
      });
      return it('calls the notifying callback, if set', function() {
        var service, spy;
        spy = sinon.spy();
        service = new DownloadService({}, {});
        service.onPercentageChange = spy;
        service.notifyCompletedJob();
        return expect(spy.called).toBe(true);
      });
    });
  });

}).call(this);
