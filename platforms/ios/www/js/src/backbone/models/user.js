// Generated by CoffeeScript 1.9.0
(function() {
  var _base,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __hasProp = {}.hasOwnProperty;

  window.BlueCarbon || (window.BlueCarbon = {});

  (_base = window.BlueCarbon).Models || (_base.Models = {});

  BlueCarbon.Models.User = (function(_super) {
    __extends(User, _super);

    function User() {
      return User.__super__.constructor.apply(this, arguments);
    }

    User.prototype.schema = function() {
      return "sqlite_id INTEGER PRIMARY KEY, id INTEGER, auth_token TEXT, email TEXT";
    };

    User.prototype.login = function(form, options) {
      return $.ajax({
        type: 'GET',
        url: 'http://bluecarbon.unep-wcmc.org/admins/me.json',
        success: options.success,
        error: (function(_this) {
          return function(data) {
            _this.set('email', form.email);
            if (data.error != null) {
              return $.ajax({
                type: 'POST',
                url: 'http://bluecarbon.unep-wcmc.org/my/admins/sign_in.json',
                data: {
                  admin: {
                    email: form.email,
                    password: form.password
                  }
                },
                dataType: "json",
                success: function(data) {
                  _this.set('auth_token', data.auth_token);
                  return _this.localSave({}, {
                    success: function(a, b, c) {
                      options.success(_this);
                      BlueCarbon.bus.trigger('user:gotAuthToken', data.auth_token);
                      return BlueCarbon.bus.trigger('user:loggedIn', _this);
                    }
                  });
                },
                error: options.error
              });
            } else {
              return options.error(data);
            }
          };
        })(this)
      });
    };

    User.prototype.logout = function(options) {
      return this.localDestroy({
        success: function() {
          BlueCarbon.bus.trigger('user:gotAuthToken', '');
          return options.success();
        }
      });
    };

    return User;

  })(Backbone.SyncableModel);

}).call(this);
